# Learning Quasi-LPV Models and Robust Control Invariant Sets with Reduced Conservativeness
This repository contains the code for the paper  "Learning Quasi-LPV Models and Robust Control Invariant Sets with
 Reduced Conservativeness" by S.K.Mulagaleti and A.Bemporad

## Requirements

This project requires the following Python packages:

- [jax](https://github.com/google/jax)
- [jax.numpy](https://jax.readthedocs.io/en/latest/jax.numpy.html)
- [jax.scipy](https://jax.readthedocs.io/en/latest/jax.scipy.html)
- [numpy](https://numpy.org/)
- [flax](https://github.com/google/flax)
- [jax_sysid](https://github.com/bemporad/jax-sysid)
- [jaxopt](https://github.com/google/jaxopt)
- [qpax](https://github.com/kevin-tracy/qpax)
- [casadi](https://web.casadi.org/)
- [matplotlib](https://matplotlib.org/)
- [pycvxset](https://github.com/merlresearch/pycvxset) 
- [scipy](https://www.scipy.org/)
- [control](https://python-control.readthedocs.io/)

## How to run the code
The main file to run is 'main.py'. This file consists of the following three main parts:
1. Generate/Load dataset
2. Initialization of model parameters
3. Concurrent identification

All three parts output a pickle file containing the results.
These files are present in the folder 'identification_results/$folder_name$'
If the file already exists, the results are not recomputed.
To recompute the results, set overwrite_data = True in the function call.

In Step 1: 
- Select the plant model and the number of training and testing samples.
- The base class for plant models is in plant_models/plant_model.py
- The function to generate the dataset is in data_generation.py
- The options to pass to this function are:
    - scale_data: Boolean to scale the data
    - N_train: Number of training samples
    - N_test: Number of testing samples
    - overwrite_data: Boolean to overwrite the existing dataset or not
- By default, the inputs in the dataset are generated by randomly sampling from the input constraints.
- By uncommenting the line 'U_tot = generate_multisine(nu, N_train, 0.1, 100, -system.u_lim, system.u_lim, 10)' in data_generation.py, the inputs are generated using a multi-sine signal.
- The multisine function is present in the folder 'utils'.

In Step 2:
- An initial qLPV model is identified using the function 'initialization_qLPV.py'. 
- The function 'initialization_qLPV.py' also identifies an initial RCI set for the qLPV model.

In Step 3:
- The function 'concurrent_identification.py' computes the qLPV model, with control-invariant set regularization. The set template was constructed in Step 2.


## Additional Notes
- The template matrix $\tilde{F}$ is selected in the function 'initialization_qLPV.py'. By default, the set $X=\{x:\tilde{F}x \leq 1\}$ is set to be the $$\infty$$-norm ball. This can be changed by modifying the function.

- The function utils/qLPV_BFR.py computes the BFRs for the models. It reads a dictionary of the model parameters, lists of inputs and outputs, and option to use observer gain.

- The script controller_synthesis/tracking_NMPC.py synthesizes and tests the safe tracking controller. It uses the model class in controller_synthesis/qLPV_model.py which is initialized using the parameters from Step 3. 

- The script 'Algorithm_1.py' evaluates the regularizaiton $r(\Theta)$ using the bound propagation technique, implementing Algorithm 1 in the paper.

- The function sequential_benchmark identifies an qLPV model, following which it computes the maximal RCI set and evalutes the regularization $r(\Theta)$ over that set.

## Installation

You can install a part of the required packages using `pip`:

```bash
pip install jax jaxlib numpy flax jax-sysid jaxopt qpax casadi matplotlib scipy control
```

- Please refer to https://github.com/merlresearch/pycvxset for installation of pycvxset. Functions from this package are used for polytope operations.

